package com.jun.mail.domain.mail

import io.github.resilience4j.circuitbreaker.CircuitBreaker
import io.github.resilience4j.circuitbreaker.CircuitBreakerRegistry
import org.assertj.core.api.Assertions.assertThat
import org.junit.jupiter.api.BeforeEach
import org.junit.jupiter.api.Test
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.boot.test.context.SpringBootTest
import org.springframework.test.context.ActiveProfiles

@SpringBootTest
@ActiveProfiles("test")
class SendgridCircuitBreakerHalfOpenTest @Autowired constructor(
    private val sendgridMailService: SendgridMailService,
    private val circuitBreakerRegistry: CircuitBreakerRegistry,
) {

    private lateinit var cb: CircuitBreaker

    @BeforeEach
    fun setup() {
        cb = circuitBreakerRegistry.circuitBreaker("sendgrid")
        // Ensure a clean state before each test
        cb.transitionToClosedState()
    }

    @Test
    fun `circuit transitions to HALF_OPEN after open wait duration and goes back to OPEN on failure`() {
        // 1) Trigger OPEN: with test config slidingWindowSize=2, minimumNumberOfCalls=2
        repeat(2) {
            try {
                sendgridMailService.sendMail(1L, "from@example.com", "to@example.com", "hello")
            } catch (_: Exception) {
                // expected failures
            }
        }
        assertThat(cb.state).isEqualTo(CircuitBreaker.State.OPEN)

        // 2) Wait until it automatically transitions to HALF_OPEN
        // test profile: waitDurationInOpenState=1s and automaticTransition...=true
        waitUntilHalfOpen(cb)
        assertThat(cb.state).isEqualTo(CircuitBreaker.State.HALF_OPEN)

        // 3) In HALF_OPEN, only 1 permitted call (permittedNumberOfCallsInHalfOpenState=1)
        // Our call still fails, so the CB should move back to OPEN immediately
        try {
            sendgridMailService.sendMail(2L, "from@example.com", "to@example.com", "world")
        } catch (_: Exception) {
            // expected failure
        }

        assertThat(cb.state).isEqualTo(CircuitBreaker.State.OPEN)
    }

    private fun waitUntilHalfOpen(cb: CircuitBreaker, timeoutMillis: Long = 3000L) {
        val start = System.currentTimeMillis()
        while (System.currentTimeMillis() - start < timeoutMillis) {
            if (cb.state == CircuitBreaker.State.HALF_OPEN) return
            Thread.sleep(100)
        }
    }
}
